# üìã Notas Explicativas - Fluxo de Recebimento de Mensagem WhatsApp

## üéØ Vis√£o Geral do Sistema
**Vers√£o**: 4.0 - Alinhamento Completo com Diagrama Atualizado
**Data**: 15 de julho de 2025

Este fluxo representa o processo completo de **recebimento, processamento e resposta** de mensagens WhatsApp no sistema de atendimento inteligente. O sistema combina **automa√ß√£o via IA** com **atendimento humano** para oferecer suporte eficiente.

### ‚ú® **Principais Caracter√≠sticas**:
1. **Tratamento Completo de M√≠dia**: IA converte √°udio, imagem e documentos para texto
2. **Direcionamento Inteligente**: Sistema detecta atendente respons√°vel e direciona automaticamente
3. **Classifica√ß√£o Inteligente de Intent**: Distingue perguntas, satisfa√ß√£o e transfer√™ncias
4. **Transfer√™ncia Avan√ßada**: Suporte a transfer√™ncia por setor e entre atendentes espec√≠ficos
5. **Loop Otimizado**: Bot retorna para in√≠cio do fluxo, passando por classifica√ß√£o intent
6. **Busca Especializada**: Sistema busca atendentes por setor quando necess√°rio
7. **Controle Hier√°rquico**: Estrutura numerada facilita navega√ß√£o e manuten√ß√£o

### üîÑ **Estrutura Hier√°rquica de Loops**
1. **6.9.1**: Loop nova mensagem bot - retorna para in√≠cio (1.1) via intent (6.1)
2. **7.4.1**: Loop de busca por atendente (sub-n√≠vel de 7.4)
3. **8.1.3**: Loop notifica√ß√£o atendente (sub-n√≠vel de 8.1)
4. **8.1.4**: Loop nova mensagem durante espera atendente (sub-n√≠vel de 8.1)
5. **8.10.1**: Loop nova mensagem cliente para humano (sub-n√≠vel de 8.10)

**Vantagem**: A numera√ß√£o hier√°rquica torna claro que os loops s√£o **extens√µes** dos processos principais, com **classifica√ß√£o de intent** determinando fluxos espec√≠ficos (pergunta vs satisfa√ß√£o).

---

## üöÄ 1. IN√çCIO DO FLUXO - Nova Mensagem Recebida

### üì± 1.1 **Receber Mensagem WhatsApp**
**Processo**: Captura inicial da mensagem do cliente
- **Dados Coletados**:
  - `numero_cliente`: Telefone do remetente (formato internacional)
  - `conteudo`: Texto, √°udio, imagem ou documento
  - `tipo_mensagem`: TEXTO, IMAGEM, AUDIO, VIDEO, DOCUMENTO
  - `message_id`: ID √∫nico da mensagem no WhatsApp

**Import√¢ncia**: Este √© o ponto de entrada √∫nico para todas as intera√ß√µes. A qualidade dos dados coletados aqui impacta todo o processamento posterior.

### ‚öôÔ∏è 1.2 **Fun√ß√£o: processar_mensagem_whatsapp**
**Processo**: Normaliza√ß√£o e valida√ß√£o inicial dos dados
- **Normaliza√ß√£o do Telefone**:
  - Adiciona c√≥digo do pa√≠s (+55 para Brasil)
  - Remove caracteres especiais e espa√ßos
  - Formato final: `+5511999999999`
- **Buscar ou Criar Cliente**:
  - Verifica se o n√∫mero j√° existe no banco
  - Cria novo registro se necess√°rio
  - Atualiza metadados de contato

**T√©cnica**: Utiliza Django ORM com `get_or_create()` para evitar duplicatas.

### ‚ùì 1.3 **Decis√£o: Tipo da mensagem √© TEXTO?**
**Processo**: Verifica√ß√£o do tipo de conte√∫do recebido
- **TEXTO**: Prossegue diretamente para verifica√ß√£o de atendimento ativo
- **N√ÉO-TEXTO**: Direciona para processamento de convers√£o via IA
- **Tipos Suportados**: AUDIO, IMAGEM, VIDEO, DOCUMENTO, STICKER

### ü§ñ 1.4 **Processar Conte√∫do N√£o-Texto**
**Processo**: Identifica√ß√£o e prepara√ß√£o para convers√£o
- **AUDIO**: Preparar para transcri√ß√£o de voz para texto
- **IMAGEM**: Preparar para an√°lise de conte√∫do visual
- **DOCUMENTO**: Preparar para extra√ß√£o de texto (PDF, DOC, etc.)
- **VIDEO**: Preparar para transcri√ß√£o de √°udio do v√≠deo
- **Valida√ß√£o**: Verificar formato e tamanho do arquivo

### üìù 1.5 **Converter para Texto via IA Agent**
**Processo**: Convers√£o inteligente de conte√∫do multim√≠dia
- **Transcri√ß√£o de √Åudio**: 
  - Utiliza modelos de Speech-to-Text
  - Identifica idioma automaticamente
  - Filtra ru√≠dos e melhora qualidade
- **An√°lise de Imagem**:
  - OCR para texto em imagens
  - Descri√ß√£o de conte√∫do visual
  - Identifica√ß√£o de elementos relevantes
- **Extra√ß√£o de Documento**:
  - Parse de PDFs e documentos
  - Preserva formata√ß√£o importante
  - Extrai texto estruturado
- **Processamento de V√≠deo**:
  - Extrai trilha de √°udio
  - Transcreve conte√∫do falado
  - Identifica cenas relevantes

**Resultado**: Conte√∫do convertido em formato texto mantendo refer√™ncia ao arquivo original.

---

## üîç 2. VERIFICA√á√ÉO DE ATENDIMENTO ATIVO - buscar_atendimento_ativo

### üîç 2.1 **Fun√ß√£o: buscar_atendimento_ativo**
**Processo**: Localiza conversas em andamento
- **Status Verificados**:
  - `AGUARDANDO_INICIAL`: Novo atendimento criado
  - `EM_ANDAMENTO`: Conversa ativa com bot ou humano
  - `AGUARDANDO_CLIENTE`: Aguardando resposta do cliente
  - `AGUARDANDO_ATENDENTE`: Aguardando a√ß√£o do atendente humano

**L√≥gica de Neg√≥cio**: Um cliente s√≥ pode ter **um atendimento ativo** por vez. Isso evita fragmenta√ß√£o de conversas e mant√©m contexto.

### üìã 2.2 **Decis√£o: Existe atendimento ativo?**
**Crit√©rio**: Busca por atendimento com status n√£o finalizado
- **SIM**: Verifica se tem atendente respons√°vel (2.3)
- **N√ÉO**: Inicia novo atendimento (nova jornada)

### üë§ 2.3 **Decis√£o: Atendimento tem atendente respons√°vel?**
**Processo**: Verifica√ß√£o de responsabilidade definida
- **SIM**: Direciona para atendente respons√°vel (2.4)
- **N√ÉO**: Continua fluxo normal sem respons√°vel (4.1)

### üéØ 2.4 **Direcionar para Atendente Respons√°vel**
**Processo**: Bypass do controle do bot
- **Prioridade**: Mensagem vai diretamente para atendente definido
- **Contexto**: Ignora triagem geral do sistema
- **Efici√™ncia**: Conex√£o direta com respons√°vel

### üíæ 2.5 **CREATE Mensagem Direta**
**Processo**: Salvamento para atendente respons√°vel
- **Conte√∫do**: Mensagem completa do cliente
- **Remetente**: `CLIENTE`
- **Vincula√ß√£o**: Relaciona ao atendimento com respons√°vel
- **Timestamp**: Autom√°tico

### üíæ 2.6 **UPDATE Cliente - Intera√ß√£o Direta**
**Processo**: Atualiza√ß√£o para fluxo direto
- **Campo**: `ultima_interacao = now`
- **Contexto**: Rastreamento de atividade com respons√°vel
- **Analytics**: M√©tricas de direcionamento direto

---

## üÜï 3. CRIAR NOVO ATENDIMENTO - inicializar_atendimento_whatsapp

### üíæ 3.1 **GET_OR_CREATE Cliente**
- **Campos Principais**:
  - `telefone`: Normalizado para +55XXXXXXXXXX
  - `nome`: Extra√≠do da mensagem se fornecido
  - `data_cadastro`: Timestamp autom√°tico
  - `canal_origem`: 'WHATSAPP'
- **Metadados Iniciais**:
  - IP de origem (se dispon√≠vel)
  - User Agent do WhatsApp
  - Localiza√ß√£o aproximada

### üíæ 3.2 **CREATE Atendimento**
- **Status Inicial**: `AGUARDANDO_INICIAL`
- **Contexto**: Informa√ß√µes do canal WhatsApp
- **Hist√≥rico**: Log inicial de cria√ß√£o
- **Campos Autom√°ticos**:
  - `data_inicio`: Timestamp de cria√ß√£o
  - `canal`: 'WHATSAPP'
  - `status`: Enum com controle de estado

### üíæ 3.3 **CREATE Mensagem (Primeira)**
- **Conte√∫do**: Texto completo da mensagem original
- **Remetente**: `CLIENTE` (enum)
- **Tipo**: Detectado automaticamente (TEXTO/IMAGEM/etc)
- **Rastreamento**: `message_id_whatsapp` para evitar duplicatas
- **Timestamp**: Autom√°tico via `auto_now_add=True`

### üíæ 3.4 **UPDATE Atendimento - Status: EM_ANDAMENTO**
- **Transi√ß√£o**: `AGUARDANDO_INICIAL` ‚Üí `EM_ANDAMENTO`
- **Hist√≥rico**: "Primeira mensagem recebida e processada"
- **Trigger**: Ativa o controle central do bot

---

## üîÑ 4. CONTINUAR ATENDIMENTO EXISTENTE - Continuar Conversa

### üíæ 4.1 **CREATE Mensagem (Continua√ß√£o)**
- **Vincula√ß√£o**: Relaciona √† conversa existente via FK
- **Sequ√™ncia**: Mant√©m ordem cronol√≥gica
- **Contexto**: Preserva hist√≥rico completo da conversa

### üíæ 4.2 **UPDATE Cliente - √öltima Intera√ß√£o**
- **Campo**: `ultima_interacao = now`
- **Objetivo**: Rastreamento de atividade do cliente
- **Uso**: Analytics e m√©tricas de engajamento

---

## üîß 5. CONTROLE CENTRAL DO BOT - Assumir Controle Direto

### ÔøΩ 5. **Controle Central do Bot**
**Processo**: Bot assume controle do atendimento
- **Condi√ß√£o**: N√£o h√° atendente humano respons√°vel
- **Verifica√ß√£o**: J√° realizada na se√ß√£o 2.3
- **A√ß√£o**: Processar automaticamente via IA
- **Simplifica√ß√£o**: Controle direto sem verifica√ß√µes redundantes

---

## ü§ñ 6. FLUXO DE RESPOSTA DO BOT - Analisar e Classificar Intent

### üß† 6. **An√°lise de Mensagem**
**Processo**: An√°lise inicial e prepara√ß√£o para classifica√ß√£o
- **IA Anal√≠tica**: Processa mensagem com modelos de linguagem
- **Extra√ß√£o**: Intent, entidades e contexto da conversa
- **Base de Conhecimento**: Consulta informa√ß√µes relevantes
- **Prepara√ß√£o**: Dados estruturados para classifica√ß√£o

### ‚ùì 6.1 **Classificar Intent**
**Processo**: Decis√£o cr√≠tica sobre o tipo de mensagem do cliente
- **PERGUNTA**: Cliente faz questionamento ou solicita informa√ß√£o
  - Exemplos: "Como fa√ßo para...", "Qual √© o valor de...", "Preciso de ajuda com..."
  - A√ß√£o: Direciona para gera√ß√£o de resposta (6.2)
- **AGRADECIMENTO/SATISFA√á√ÉO**: Cliente demonstra resolu√ß√£o ou gratid√£o
  - Exemplos: "Obrigado", "Resolvido", "J√° consegui", "Perfeito", "Muito obrigado"
  - A√ß√£o: Direciona para detec√ß√£o de satisfa√ß√£o (6.3)
- **TRANSFER√äNCIA**: Cliente solicita mudan√ßa de setor ou atendente
  - Exemplos: "Quero falar com o financeiro", "Preciso falar com um supervisor"
  - A√ß√£o: Direciona para intent de transfer√™ncia (6.1.1)

### üîÑ 6.1.1 **Detectar Intent Transfer√™ncia**
**Processo**: Identifica√ß√£o de solicita√ß√£o de mudan√ßa de setor
- **An√°lise**: Cliente solicita mudan√ßa de setor ou especialista
- **Extra√ß√£o**: Identifica setor destino da mensagem
- **Exemplos**: "quero falar financeiro", "preciso suporte t√©cnico"
- **A√ß√£o**: Direciona para busca de atendente (7. TRANSFER√äNCIA)

### üí≠ 6.2 **Gerar Resposta**
**Processo**: Cria√ß√£o de resposta para perguntas
- **IA Generativa**: Processa pergunta com modelo de linguagem
- **C√°lculo de Confian√ßa**: Score de 0.0 a 1.0
- **Personaliza√ß√£o**: Adapta tom e conte√∫do ao contexto
- **Prepara√ß√£o**: Resposta estruturada para avalia√ß√£o

### ‚úÖ 6.3 **Detectar Satisfa√ß√£o**
**Processo**: Processamento de sinais de resolu√ß√£o
- **An√°lise Sem√¢ntica**: Identifica express√µes de satisfa√ß√£o
- **Contexto**: Avalia se problema foi realmente resolvido
- **Agradecimento**: Processa diferentes formas de gratid√£o
- **Encerramento**: Prepara finaliza√ß√£o autom√°tica do atendimento

### ‚ùì 6.4 **Verifica√ß√£o: Confian√ßa >= 0.5?**
**Primeiro Filtro**: Avalia√ß√£o inicial de confian√ßa para perguntas
- **< 0.5**: Direcionamento para **6.5 transferir_atendimento_automatico**
- **‚â• 0.5**: Prossegue para segundo filtro (6.6)

### üë§ 6.5 **transferir_atendimento_automatico**
**Processo**: Transfer√™ncia por baixa confian√ßa
- **Motivo**: Baixa confian√ßa na resposta gerada
- **A√ß√£o**: Transferir para atendente humano
- **Status**: Escala√ß√£o autom√°tica

### ‚ùì 6.6 **Verifica√ß√£o: Confian√ßa >= 0.8?**
**Segundo Filtro**: Avalia√ß√£o de alta confian√ßa
- **‚â• 0.8**: **6.7 Resposta Autom√°tica** (alta confian√ßa)
- **0.5-0.8**: **6.8 Resposta Requer Revis√£o** (confian√ßa m√©dia)

### üì§ 6.7 **Resposta Autom√°tica**
**Processo**: Envio direto ao cliente
- **Remetente**: `BOT` (identifica√ß√£o clara)
- **A√ß√£o**: Salvar mensagem BOT e enviar para cliente
- **Confian√ßa**: Alta confian√ßa (‚â• 0.8)

### ‚ö†Ô∏è 6.8 **Resposta Requer Revis√£o**
**Processo**: Resposta com supervis√£o
- **Salvamento**: Resposta preparada com baixa confian√ßa
- **L√≥gica**: Customiz√°vel conforme regras de neg√≥cio
- **Confian√ßa**: M√©dia (0.5-0.8)

---

## ‚è≥ 6.9 **FLUXO ESPEC√çFICO DO BOT - Aguardar e Loop Inteligente**

### ‚è≥ 6.9 **Bot Aguarda Resposta Cliente**
**Processo**: Monitoramento automatizado com loop inteligente
- **Status**: `AGUARDANDO_CLIENTE`
- **Timeout**: Configur√°vel (ex: 30 minutos sem resposta)
- **Loop**: Sistema mant√©m conversa at√© satisfa√ß√£o ou timeout
- **Intelig√™ncia**: Retorna para classifica√ß√£o de intent (6.1) automaticamente

### üîÑ 6.9.1 **Nova Mensagem Cliente**
**Processo**: Retorno inteligente para in√≠cio do fluxo
- **A√ß√£o**: Quando cliente responde, retorna para item **1.1** (Receber Mensagem)
- **Classifica√ß√£o**: Nova mensagem passa novamente por **6.1** (Classificar Intent)
- **Efici√™ncia**: Satisfa√ß√£o √© detectada automaticamente no intent
- **Loop**: Processo continua at√© cliente demonstrar satisfa√ß√£o ou timeout

### ‚è∞ **Timeout Cliente**
**Processo**: Encerramento por inatividade
- **Trigger**: Cliente n√£o responde no prazo estabelecido
- **A√ß√£o**: Direciona para **9. ENCERRAR ATENDIMENTO**
- **Automatiza√ß√£o**: Sistema finaliza conversa automaticamente

---

## üë• 7. TRANSFER√äNCIA PARA ATENDENTE - buscar_atendente_disponivel

### üîç 7.1 **Fun√ß√£o: buscar_atendente_disponivel**
**Processo**: Localiza√ß√£o de atendente apropriado
- **Filtros**:
  - `ativo=True`: Atendente logado no sistema
  - `disponivel=True`: N√£o est√° em pausa/ausente
  - `max_atendimentos_simultaneos`: Respeita limite de carga
- **Balanceamento**: Distribui carga entre atendentes

### üè¢ 7.1.1 **Decis√£o: Transfer solicitada para setor espec√≠fico?**
**Processo**: Verifica√ß√£o de especializa√ß√£o requerida
- **SIM**: Busca atendente por setor espec√≠fico (7.1.2)
- **N√ÉO**: Busca atendente geral dispon√≠vel (7.2)

### üè¢ 7.1.2 **buscar_atendente_por_setor**
**Processo**: Busca especializada por setor
- **Filtros**: Atendentes do setor espec√≠fico
- **Prioriza√ß√£o**: Especialistas do setor em quest√£o
- **Verifica√ß√£o**: Disponibilidade dentro do setor
- **Balanceamento**: Distribui carga dentro do setor

### ‚ùì 7.2 **Decis√£o: Atendente Dispon√≠vel?**

#### ‚ùå **N√ÉO - 7.3 Nenhum Atendente Dispon√≠vel**
**Processo**: Gerenciamento de fila com loop cont√≠nuo
- **Notifica√ß√£o**: Administradores alertados em tempo real
- **Estrat√©gia**: Sistema inicia loop de busca cont√≠nua
- **Escala√ß√£o**: Processo autom√°tico de chamada repetitiva
- **Monitoramento**: Log de tentativas e intervalos

### ‚è≥ 7.4 **Aguardar e Tentar Novamente**
**Processo**: Loop inteligente de busca por atendente
- **Intervalo**: Aguarda tempo configur√°vel entre tentativas
- **Contador**: Incrementa n√∫mero de tentativas
- **Log**: Registra cada ciclo de busca
- **Persist√™ncia**: Mant√©m tentativas at√© encontrar atendente dispon√≠vel

### üîÑ 7.4.1 **Nova Busca (Loop)**
**Processo**: Retorno autom√°tico para busca de atendente
- **Autom√°tico**: Sistema retorna automaticamente para item 7.1
- **Cont√≠nuo**: Loop persiste at√© encontrar atendente dispon√≠vel
- **Inteligente**: Cada ciclo inclui notifica√ß√£o administrativa
- **Configur√°vel**: Intervalo de tentativas pode ser ajustado

#### ‚úÖ **SIM - 7.5 transferir_para_humano**
**Processo**: Atribui√ß√£o de atendente
- **Atualiza√ß√£o**: `atendimento.atendente_humano = atendente`
- **Status**: `TRANSFERIDO`
- **Hist√≥rico**: Log da transfer√™ncia autom√°tica
- **Notifica√ß√£o**: Alerta em tempo real para atendente

### üì¨ 7.6 **Notificar Atendente**
**Processo**: Prepara√ß√£o para atendimento humano
- **Interface**: Prepara dashboard do atendente
- **Contexto**: Hist√≥rico completo da conversa
- **Ferramentas**: Acesso a informa√ß√µes do cliente

### üë§ 7.7 **Atendente Assume Controle**
**Processo**: Transfer√™ncia de responsabilidade
- **Bot**: Para de responder automaticamente
- **Controle**: Passa totalmente para o atendente humano
- **Estado**: Atendimento sob supervis√£o humana


---

## üë§ 8. ATENDIMENTO HUMANO ATIVO - Aguardar A√ß√£o do Atendente

### ‚è≥ 8.1 **Aguardar A√ß√£o do Atendente**
**Estado**: `AGUARDANDO_ATENDENTE`
- **Interface**: Dashboard em tempo real
- **Alertas**: Notifica√ß√µes de novas mensagens
- **Ferramentas**: Acesso a hist√≥rico e recursos

### ‚ùì 8.1 **Decis√£o: Atendente Enviou Resposta?**
**Processo**: Verifica√ß√£o de a√ß√£o do atendente com timeout inteligente

#### ‚è∞ 8.1.1 **Aguardar Timeout Atendente**
**Processo**: Monitoramento de tempo limite com notifica√ß√£o proativa
- **Per√≠odo**: Configur√°vel (ex: 5-10 minutos)
- **Monitoramento**: Sistema rastreia tempo de inatividade
- **Trigger**: Acionado quando atendente n√£o responde no prazo
- **Log**: Registra tentativas de notifica√ß√£o

#### üì¢ 8.1.2 **Notificar Atendente Novamente**
**Processo**: Sistema de lembrete proativo
- **Alerta**: Notifica√ß√£o de timeout no dashboard
- **Conte√∫do**: "Lembrete: Resposta pendente para cliente [nome/telefone]"
- **Escala√ß√£o**: Incrementa contador de notifica√ß√µes
- **Persist√™ncia**: Mant√©m alertas at√© resposta ou finaliza√ß√£o

#### üîÑ 8.1.3 **Loop Notifica√ß√£o Atendente (Loop Hier√°rquico)**
**Processo**: Ciclo cont√≠nuo de notifica√ß√£o at√© resposta ou fechamento
- **Hierarquia**: Sub-n√≠vel do item 8.1 (Aguardar A√ß√£o do Atendente)
- **Retorno**: Volta para decis√£o 8.1 (Atendente enviou resposta?)
- **Op√ß√µes de Sa√≠da**: Atendente responder OU decidir fechar atendimento
- **Persist√™ncia**: Continua at√© uma das duas a√ß√µes acima
- **Configur√°vel**: Intervalo entre notifica√ß√µes ajust√°vel

#### üîÑ 8.1.4 **Nova Mensagem Cliente Loop (Loop Hier√°rquico)**
**Processo**: Reativa√ß√£o por nova mensagem do cliente
- **Hierarquia**: Sub-n√≠vel do item 8.1 (Aguardar A√ß√£o do Atendente)
- **Prioridade**: Nova mensagem interrompe ciclo de notifica√ß√£o
- **Continuidade**: Fluxo retorna ao in√≠cio (item 1.1) mantendo contexto humano
- **Notifica√ß√£o**: Atendente √© imediatamente alertado sobre nova mensagem

### üíæ 8.2 **enviar_mensagem_atendente**
**Processo**: Processamento de mensagem do atendente
- **Remetente**: `ATENDENTE_HUMANO`
- **Rastreamento**: `ultima_atividade` atualizada
- **Metadados**: ID do atendente, timestamp
- **Controle**: Bot permanece inativo

### üîÑ 8.3 **Decis√£o: Atendente solicitou transfer√™ncia?**
**Processo**: Verifica√ß√£o de comando de transfer√™ncia
- **Comando**: Detecta `/transfer` ou equivalente
- **SIM**: Processa comando de transfer√™ncia (8.4)
- **N√ÉO**: Continua fluxo normal (8.9)

### üîÑ 8.4 **processar_comando_transferencia**
**Processo**: An√°lise do comando de transfer√™ncia
- **Extra√ß√£o**: Setor ou atendente destino
- **Valida√ß√£o**: Verifica permiss√µes do atendente
- **Prepara√ß√£o**: Organiza hist√≥rico para transfer√™ncia
- **Log**: Registra motivo da transfer√™ncia

### üéØ 8.5 **Decis√£o: Tipo de Transfer√™ncia?**
**Processo**: Classifica√ß√£o do destino da transfer√™ncia
- **SETOR**: Transfer√™ncia para setor espec√≠fico (8.5.1)
- **ATENDENTE**: Transfer√™ncia para atendente espec√≠fico (8.5.2)

### üè¢ 8.5.1 **transferir_para_setor**
**Processo**: Transfer√™ncia por especializa√ß√£o
- **Busca**: Atendentes dispon√≠veis do setor
- **Crit√©rios**: Aplicar regras de disponibilidade
- **Balanceamento**: Distribuir carga dentro do setor
- **Especializa√ß√£o**: Priorizar expertise espec√≠fica

### üë§ 8.5.2 **transferir_para_atendente_especifico**
**Processo**: Transfer√™ncia direcionada
- **Valida√ß√£o**: Verificar se atendente existe
- **Disponibilidade**: Checar status do atendente
- **For√ßar**: Permite transfer√™ncia mesmo se ocupado
- **Prioridade**: Atendimento espec√≠fico solicitado

### üìù 8.6 **atualizar_historico_transferencia**
**Processo**: Registro completo da transfer√™ncia
- **Origem**: Registrar atendente que transferiu
- **Destino**: Registrar novo respons√°vel
- **Motivo**: Documentar raz√£o da transfer√™ncia
- **Timestamp**: Marcar momento da transfer√™ncia

### üì¨ 8.7 **notificar_novo_atendente**
**Processo**: Comunica√ß√£o ao novo respons√°vel
- **Contexto**: Enviar hist√≥rico completo da conversa
- **Detalhes**: Informa√ß√µes sobre a transfer√™ncia
- **Interface**: Preparar dashboard para novo atendente
- **Alerta**: Notifica√ß√£o em tempo real

### üì§ 8.8 **notificar_atendente_origem**
**Processo**: Confirma√ß√£o para quem transferiu
- **Confirma√ß√£o**: Validar que transfer√™ncia foi conclu√≠da
- **Libera√ß√£o**: Remover conversa da lista do atendente
- **Contadores**: Atualizar m√©tricas de atendimento
- **Status**: Liberar para novos atendimentos

### ‚ùì 8.9 **Decis√£o: Atendente Escolhe Pr√≥ximo Passo?**
**Processo**: Controle total do atendente sobre o fluxo
- **Interface**: Dashboard com op√ß√µes claras
- **Finalizar Agora**: Atendente avalia que problema foi resolvido
- **Aguardar Cliente**: Espera resposta do cliente para continuar
- **Autonomia**: Decis√£o exclusiva do atendente humano

### ‚è≥ 8.10 **Humano Aguarda Cliente**
**Processo**: Espera controlada por atendente
- **Status**: `AGUARDANDO_CLIENTE_HUMANO`
- **Timeout**: Sem timeout autom√°tico de encerramento
- **Controle**: Atendente mant√©m responsabilidade total
- **Flexibilidade**: Pode aguardar indefinidamente se necess√°rio

### üîÑ 8.10.1 **Nova Mensagem Cliente Loop (Loop Hier√°rquico)**
**Processo**: Reativa√ß√£o por nova mensagem do cliente
- **Hierarquia**: Sub-n√≠vel do item 8.10 (Humano Aguarda Cliente)
- **Prioridade**: Cliente responde mantendo controle humano
- **Continuidade**: Fluxo retorna ao in√≠cio (item 1.1) preservando contexto humano
- **Notifica√ß√£o**: Atendente √© imediatamente alertado sobre nova mensagem

### üèÅ 8.11 **Atendente Finaliza Agora**
**Processo**: Encerramento direto pelo atendente
- **Crit√©rio**: Atendente considera problema resolvido
- **A√ß√£o**: Direcionamento imediato para se√ß√£o 9 (Encerramento)
- **Controle**: Bypassa verifica√ß√µes autom√°ticas
- **Responsabilidade**: Atendente assume decis√£o de encerramento

---

## üèÅ 9. ENCERRAR ATENDIMENTO - finalizar_atendimento

### üèÅ 9.1 **Gerar Mensagem Final**
**Conte√∫do Padr√£o**:
- Resumo da conversa e solu√ß√µes fornecidas
- Solicita√ß√£o de avalia√ß√£o (NPS/satisfa√ß√£o)
- Mensagem de despedida personalizada
- Informa√ß√µes de contato para futuro suporte

### üíæ 9.2 **UPDATE Atendimento - Status: RESOLVIDO**
- **Status Final**: `RESOLVIDO`
- **Timestamp**: `data_fim = now`
- **Hist√≥rico**: "Atendimento finalizado com sucesso"
- **M√©tricas**: Tempo total, n√∫mero de mensagens

### üíæ 9.3 **CREATE Mensagem (Encerramento)**
- **Conte√∫do**: Mensagem final de encerramento
- **Remetente**: `BOT`
- **Timestamp**: Autom√°tico
- **Finaliza√ß√£o**: √öltima mensagem do atendimento

### üì§ 9.4 **Enviar Mensagem Final**
**Processo**: Comunica√ß√£o de encerramento
- **Avalia√ß√£o**: Link ou formul√°rio de feedback
- **Follow-up**: Agendamento de contato futuro se necess√°rio
- **Documenta√ß√£o**: Registro completo para an√°lise

### üèÅ 9.5 **Fim do Fluxo**
**Estado**: Atendimento Encerrado
- **Conclus√£o**: Processo totalmente finalizado
- **Arquivo**: Conversa arquivada para hist√≥rico
- **Disponibilidade**: Sistema pronto para nova intera√ß√£o

---

## üîÑ LOOPS HIER√ÅRQUICOS - Retornos Estruturados

### üîÑ 6.9.1 **Nova Mensagem Bot Loop (Loop Hier√°rquico)**
**Processo**: Reativa√ß√£o durante espera do bot
- **Hierarquia**: Sub-n√≠vel do item 6.9 (Bot Aguarda Resposta Cliente)
- **Contexto**: Mant√©m controle automatizado
- **Prioridade**: Nova mensagem interrompe timeout do bot
- **Continuidade**: Fluxo retorna ao in√≠cio (item 1.1) mantendo contexto bot

### üîÑ 7.4.1 **Loop de Busca por Atendente (Refer√™ncia Cruzada)**
**Processo**: Loop cont√≠nuo de busca por atendente dispon√≠vel
- **Hierarquia**: Sub-n√≠vel do item 7.4 (Aguardar e Tentar Novamente)
- **Estrat√©gia**: Busca persistente com notifica√ß√µes administrativas
- **Retorno**: Volta para item 7.1 (buscar_atendente_disponivel)
- **Efici√™ncia**: Garante que nenhum cliente fique sem atendimento

### üîÑ 8.1.3 **Loop de Notifica√ß√£o do Atendente (Refer√™ncia Cruzada)**
**Processo**: Ciclo de lembrete para atendente inativo
- **Hierarquia**: Sub-n√≠vel do item 8.1 (Aguardar A√ß√£o do Atendente)
- **Timeout**: Sistema monitora inatividade do atendente
- **Op√ß√µes de Sa√≠da**: Alertas peri√≥dicos at√© resposta OU fechamento do atendimento
- **Flexibilidade**: Atendente pode decidir encerrar sem responder
- **Retorno**: Volta para decis√£o 8.1 (Atendente enviou resposta?)

### üîÑ 8.1.4 **Nova Mensagem Atendente Loop (Loop Hier√°rquico)**
**Processo**: Interrup√ß√£o por nova mensagem durante espera do atendente
- **Hierarquia**: Sub-n√≠vel do item 8.1 (Aguardar A√ß√£o do Atendente)
- **Prioridade**: Nova mensagem tem preced√™ncia sobre timeout
- **Interrup√ß√£o**: Para ciclo de notifica√ß√£o do atendente
- **Retorno**: Fluxo volta ao in√≠cio (item 1.1) mantendo contexto humano

### üîÑ 8.10.1 **Nova Mensagem Cliente Loop para Humano (Loop Hier√°rquico)**
**Processo**: Reativa√ß√£o durante espera controlada pelo atendente
- **Hierarquia**: Sub-n√≠vel do item 8.10 (Humano Aguarda Cliente)
- **Controle**: Mant√©m responsabilidade do atendente humano
- **Flexibilidade**: Sem timeout autom√°tico de encerramento
- **Continuidade**: Fluxo retorna ao in√≠cio (item 1.1) preservando contexto humano

---

## üìä M√âTRICAS E MONITORAMENTO

### üìà **KPIs Principais**
- **Tempo de Primeira Resposta**: Bot vs Humano
- **Taxa de Resolu√ß√£o Autom√°tica**: % resolvido pelo bot
- **Satisfa√ß√£o do Cliente**: NPS e feedback
- **Efici√™ncia do Atendente**: Tempo m√©dio por atendimento

### üîç **Logs e Auditoria**
- **Rastreabilidade**: Cada a√ß√£o √© logada
- **Debugging**: Facilita identifica√ß√£o de problemas
- **Compliance**: Atende requisitos de auditoria
- **Analytics**: Base para melhorias cont√≠nuas

---

## üéØ REGRAS DE NEG√ìCIO CR√çTICAS

### üö´ **Restri√ß√µes**
1. **Um atendimento ativo por cliente**
2. **Bot respeita controle humano**
3. **Mensagens n√£o podem ser perdidas**
4. **Hist√≥rico deve ser preservado**

### ‚úÖ **Garantias**
1. **Todas as mensagens s√£o processadas**
2. **Contexto √© mantido entre sess√µes**
3. **Escala√ß√£o autom√°tica funciona**
4. **Auditoria completa est√° dispon√≠vel**
5. **Loops hier√°rquicos garantem continuidade**

---

## üîß CONSIDERA√á√ïES T√âCNICAS

### üèóÔ∏è **Arquitetura**
- **Django Models**: ORM para persist√™ncia
- **Celery**: Processamento ass√≠ncrono
- **Redis**: Cache e filas
- **mySQL**: Banco de dados principal

### üîí **Seguran√ßa**
- **Sanitiza√ß√£o**: Todos os inputs s√£o validados
- **Rate Limiting**: Prote√ß√£o contra spam
- **Encryption**: Dados sens√≠veis criptografados
- **Access Control**: Permiss√µes granulares

### üì± **Integra√ß√µes**
- **WhatsApp Business API**: Comunica√ß√£o oficial
- **IA/LLM**: Processamento de linguagem natural
- **Agentes de IA para M√≠dia**:
  - **Speech-to-Text**: Transcri√ß√£o de √°udios e v√≠deos
  - **OCR/Vision**: An√°lise de imagens e documentos
  - **Document Parser**: Extra√ß√£o de texto de PDFs e documentos
  - **Content Analyzer**: Interpreta√ß√£o inteligente de conte√∫do multim√≠dia
- **CRM**: Sincroniza√ß√£o de dados de clientes
- **Analytics**: Ferramentas de monitoramento

---

**Vers√£o**: 4.0 - Documenta√ß√£o Totalmente Alinhada com Diagrama  
**Data**: 15 de julho de 2025  
**Status**: ‚úÖ Documenta√ß√£o Sincronizada - Compatibilidade Total Verificada  
**Pr√≥xima Revis√£o**: Conforme evolu√ß√£o do sistema  
**üîó Refer√™ncia**: Totalmente alinhado com diagrama_fluxo_recebimento_mensagem.mmd  
**üìã Melhorias Principais**: 
- **Verifica√ß√£o de Atendente Respons√°vel (2.3-2.6)**: Sistema direciona automaticamente para atendente definido
- **Classifica√ß√£o de Intent (6.1)**: Sistema inteligente distingue PERGUNTA vs AGRADECIMENTO/SATISFA√á√ÉO vs TRANSFER√äNCIA
- **Intent de Transfer√™ncia (6.1.1)**: Detecta solicita√ß√µes de mudan√ßa de setor automaticamente
- **Busca por Setor (7.1.1-7.1.2)**: Sistema pode filtrar atendentes por especializa√ß√£o
- **Transfer√™ncia entre Atendentes (8.3-8.8)**: Atendentes podem transferir conversas entre si
- **Encerramento Direto**: Sinais de satisfa√ß√£o direcionam automaticamente para encerramento (6.3 ‚Üí 9)
- **Fluxo Simplificado**: Bot retorna para in√≠cio (6.9.1) passando por classifica√ß√£o intent
- **Loop Otimizado**: Elimina redund√¢ncias com classifica√ß√£o centralizada
- **Controle Hier√°rquico**: Fluxos finais distintos - Bot (6.9 simplificado) vs Humano (8.x controle manual)
- **Loops hier√°rquicos**: 6.9.1, 7.4.1, 8.1.3-8.1.4, 8.10.1 para melhor organiza√ß√£o
