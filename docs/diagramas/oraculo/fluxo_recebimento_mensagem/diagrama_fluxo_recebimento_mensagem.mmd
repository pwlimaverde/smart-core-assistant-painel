graph TD

    %% ==============================
    %% DEFINICAO DE CORES E ESTILOS
    %% ==============================
    classDef startEnd fill:#ff6b6b,stroke:#d63031,stroke-width:3px,color:white
    classDef process fill:#74b9ff,stroke:#0984e3,stroke-width:2px,color:white
    classDef decision fill:#fdcb6e,stroke:#e17055,stroke-width:2px,color:black
    classDef database fill:#55a3ff,stroke:#2d3436,stroke-width:2px,color:white
    classDef botFlow fill:#00b894,stroke:#00a085,stroke-width:2px,color:white
    classDef humanFlow fill:#e17055,stroke:#d63031,stroke-width:2px,color:white
    classDef systemFlow fill:#a29bfe,stroke:#6c5ce7,stroke-width:2px,color:white
    classDef transferFlow fill:#fd79a8,stroke:#e84393,stroke-width:2px,color:white
    classDef sectorFlow fill:#00cec9,stroke:#00b894,stroke-width:2px,color:white
    classDef todoFlow fill:#ddd,stroke:#999,stroke-width:2px,color:black
    
    %% Estilo para subgrafos da legenda (invisiveis)
    classDef legendaInvisible fill:transparent,stroke:transparent

    %% ==============================
    %% LEGENDA MELHORADA COM MAIS ESPACO
    %% ==============================
    subgraph Legenda ["ğŸ“‹ Legenda de Cores e Simbolos do Fluxo"]
        direction TB
        subgraph LegendaRow1 [" "]
            L1[ğŸš€ Inicio/Fim]:::startEnd
            L2[âš™ï¸ Processo]:::process
            L3[â“ Decisao]:::decision
        end
        subgraph LegendaRow2 [" "]
            L4[ğŸ’¾ Banco de Dados]:::database
            L5[ğŸ¤– Fluxo do Bot]:::botFlow
        end
        subgraph LegendaRow3 [" "]
            L6[ğŸ‘¤ Fluxo Humano]:::humanFlow
            L7[ğŸ”§ Sistema/Controle]:::systemFlow
        end
        subgraph LegendaRow4 [" "]
            L8[ğŸ”„ Transferencia]:::transferFlow
            L9[âš ï¸ TODO - NÃ£o Implementado]:::todoFlow
        end
    end

    %% ==============================
    %% FLUXO PRINCIPAL - IMPLEMENTACAO REAL
    %% ==============================
    
    %% 1. INICIO DO FLUXO - WEBHOOK RECEBIMENTO
    Start[ğŸš€ 1. INICIO DO FLUXO<br/>Nova Mensagem Recebida]:::startEnd
    
    %% 1.1 WEBHOOK WHATSAPP - VALIDACAO INICIAL
    ReceiveMsg[ğŸ“± 1.1 webhook_whatsapp<br/>Validar requisiÃ§Ã£o POST<br/>Parse JSON do payload<br/>Validar estrutura dados<br/>Log auditoria entrada]:::process
    
    %% 1.2 NOVA MENSAGEM - EXTRACAO DE DADOS
    ExtractMessageData[ğŸ” 1.2 nova_mensagem<br/>Extrair telefone de remoteJid<br/>Identificar tipo mensagem por chave<br/>Processar conteÃºdo especÃ­fico<br/>Extrair metadados por tipo]:::systemFlow
    
    %% 1.3 PROCESSAR MENSAGEM WHATSAPP
    CallMessageProcessor[âš™ï¸ 1.3 processar_mensagem_whatsapp<br/>Determinar remetente CLIENTE/ATENDENTE<br/>Buscar atendimento ativo<br/>Criar objeto Mensagem no BD<br/>Atualizar timestamp cliente]:::systemFlow
    
    %% 1.4 RECUPERAR OBJETO MENSAGEM
    RecoverMessage[ğŸ’¾ 1.4 Recuperar Objeto Mensagem<br/>Mensagem.objects.get por ID<br/>Acessar mensagem.atendimento<br/>Preparar para processamento]:::database
    
    %% 2. CONVERSAO DE CONTEXTO MULTIMIDIA
    CheckNonTextMessage{â“ 2.1 Mensagem nÃ£o Ã© texto?<br/>Verificar tipo != TEXTO_FORMATADO}:::decision
    ConvertContext[ğŸ¤– 2.2 _converter_contexto<br/>Converter metadados para texto<br/>ImplementaÃ§Ã£o atual: placeholder<br/>Retorna 'contexto']:::botFlow
    UpdateMessageContent[ğŸ’¾ 2.3 Atualizar ConteÃºdo Mensagem<br/>Substituir conteÃºdo original<br/>Salvar com update_fields<br/>Log conversÃ£o realizada]:::database
    
    %% 3. VERIFICACAO DE DIRECIONAMENTO
    CheckBotCanRespond[ğŸ”§ 3.1 _pode_bot_responder_atendimento<br/>Verificar ausÃªncia mensagens atendente<br/>Verificar atendimento.atendente_humano<br/>Retorna True se bot pode responder]:::systemFlow
    
    %% 4. DECISAO DE DIRECIONAMENTO
    BotCanRespond{â“ 4.1 Bot pode responder?<br/>Resultado da verificaÃ§Ã£o anterior}:::decision
    
    %% 5. FLUXO BOT - PLACEHOLDER ATUAL
    BotResponseTODO[âš ï¸ 5.1 RESPOSTA AUTOMATICA BOT<br/>TODO: NÃ£o implementado<br/>Comentado no cÃ³digo<br/>Preparado para implementaÃ§Ã£o]:::todoFlow
    
    %% 6. FLUXO HUMANO - ATUAL
    HumanFlow[ğŸ‘¤ 6.1 DIRECIONAMENTO HUMANO<br/>Mensagem direcionada para humano<br/>Verificar se tem atendente responsÃ¡vel<br/>Log direcionamento]:::humanFlow
    
    CheckResponsibleAgent{â“ 6.2 Tem atendente<br/>responsÃ¡vel?<br/>atendimento.atendente_humano}:::decision
    
    DirectToResponsible[ğŸ¯ 6.3 Direcionar para ResponsÃ¡vel<br/>Mensagem vai para atendente definido<br/>Log: direcionado para Nome<br/>Manter contexto conversa]:::humanFlow
    
    DirectToTriage[ğŸ“‹ 6.4 Direcionar para Triagem<br/>Mensagem aguarda triagem<br/>Log: direcionado para triagem<br/>Buscar atendente disponÃ­vel]:::humanFlow
    
    %% 7. RESPOSTA FINAL WEBHOOK
    ReturnSuccess[âœ… 7. RESPOSTA WEBHOOK<br/>Status: success<br/>mensagem_id: ID<br/>direcionamento: bot/humano]:::process
    ReturnError[âŒ 7.1 RESPOSTA ERRO<br/>Status HTTP apropriado<br/>Mensagem de erro<br/>Log detalhado]:::process
    
    %% 8. FIM DO FLUXO
    End[ğŸ FIM<br/>Webhook Processado]:::startEnd
    
    %% ==============================
    %% CONEXOES DO FLUXO PRINCIPAL
    %% ==============================
    
    Start --> ReceiveMsg
    ReceiveMsg --> ExtractMessageData
    ExtractMessageData --> CallMessageProcessor
    CallMessageProcessor --> RecoverMessage
    
    RecoverMessage --> CheckNonTextMessage
    CheckNonTextMessage -->|Sim| ConvertContext
    CheckNonTextMessage -->|NÃ£o| CheckBotCanRespond
    ConvertContext --> UpdateMessageContent
    UpdateMessageContent --> CheckBotCanRespond
    
    CheckBotCanRespond --> BotCanRespond
    BotCanRespond -->|True| BotResponseTODO
    BotCanRespond -->|False| HumanFlow
    
    BotResponseTODO --> ReturnSuccess
    
    HumanFlow --> CheckResponsibleAgent
    CheckResponsibleAgent -->|Sim| DirectToResponsible
    CheckResponsibleAgent -->|NÃ£o| DirectToTriage
    
    DirectToResponsible --> ReturnSuccess
    DirectToTriage --> ReturnSuccess
    
    ReturnSuccess --> End
    ReturnError --> End
    
    %% ==============================
    %% TRATAMENTO DE ERROS (simplificado)
    %% ==============================
    ReceiveMsg -.->|Erro| ReturnError
    ExtractMessageData -.->|Erro| ReturnError
    CallMessageProcessor -.->|Erro| ReturnError
    RecoverMessage -.->|Erro| ReturnError
    ConvertContext -.->|Erro| ReturnError
    CheckBotCanRespond -.->|Erro| HumanFlow
    
    %% ==============================
    %% DETALHAMENTO PROCESSOS INTERNOS
    %% ==============================
    
    subgraph DetalheBuscarAtendimento ["ğŸ” Detalhamento: buscar_atendimento_ativo"]
        direction TB
        BA1[ğŸ“ Normalizar telefone<br/>Adicionar +55 se necessÃ¡rio<br/>Limpar caracteres especiais]:::systemFlow
        BA2[ğŸ‘¤ Buscar Cliente<br/>Cliente.objects.filter<br/>Por telefone formatado]:::database
        BA3[ğŸ“‹ Buscar Atendimento Ativo<br/>Status: AGUARDANDO_INICIAL<br/>EM_ANDAMENTO, AGUARDANDO_*]:::database
        BA1 --> BA2 --> BA3
    end
    
    subgraph DetalheInicializarAtendimento ["ğŸ†• Detalhamento: inicializar_atendimento_whatsapp"]
        direction TB
        IA1[ğŸ‘¤ get_or_create Cliente<br/>Telefone formatado<br/>Metadados opcionais]:::database
        IA2[ğŸ“‹ Verificar Atendimento Ativo<br/>Evitar duplicaÃ§Ã£o<br/>Reutilizar se existir]:::database
        IA3[ğŸ†• Criar Novo Atendimento<br/>Status: AGUARDANDO_INICIAL<br/>Contexto WhatsApp]:::database
        IA4[ğŸ“ HistÃ³rico Status<br/>Registrar criaÃ§Ã£o<br/>Motivo: WhatsApp]:::database
        IA1 --> IA2 --> IA3 --> IA4
    end
    
    subgraph DetalheTiposMensagem ["ğŸ“± Detalhamento: Tipos de Mensagem Suportados"]
        direction TB
        TM1[ğŸ“ TEXTO_FORMATADO<br/>Extrai: text<br/>ConteÃºdo direto]:::process
        TM2[ğŸ–¼ï¸ IMAGEM<br/>Extrai: caption, mimetype, url<br/>fileLength para metadados]:::process
        TM3[ğŸ¥ VIDEO<br/>Extrai: caption, mimetype, url<br/>seconds, fileLength]:::process
        TM4[ğŸµ AUDIO<br/>Extrai: mimetype, url, seconds<br/>ptt para voz]:::process
        TM5[ğŸ“„ DOCUMENTO<br/>Extrai: fileName, mimetype<br/>url, fileLength]:::process
        TM6[ğŸ­ OUTROS<br/>STICKER, LOCALIZACAO<br/>CONTATO, LISTA, etc.]:::process
    end
    
    %% ==============================
    %% FUNCOES NAO IMPLEMENTADAS (TODO)
    %% ==============================
    
    subgraph TODOImplementacoes ["âš ï¸ Funcionalidades Planejadas (TODO)"]
        direction TB
        TODO1[ğŸ¤– Resposta AutomÃ¡tica Bot<br/>Gerar resposta com IA<br/>Calcular confianÃ§a<br/>Enviar automaticamente]:::todoFlow
        TODO2[ğŸ” ClassificaÃ§Ã£o Intent<br/>PERGUNTA, SATISFACAO<br/>TRANSFERENCIA, etc.]:::todoFlow
        TODO3[ğŸ”„ TransferÃªncia AutomÃ¡tica<br/>Por especialidade<br/>Por departamento]:::todoFlow
        TODO4[ğŸ” ValidaÃ§Ã£o API Key<br/>SeguranÃ§a webhook<br/>HMAC ou banco dados]:::todoFlow
        TODO5[ğŸ¯ AnÃ¡lise ConteÃºdo MÃ­dia<br/>OCR para imagens<br/>TranscriÃ§Ã£o Ã¡udio]:::todoFlow
    end
