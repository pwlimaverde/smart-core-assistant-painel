graph TD

    %% ==============================
    %% DEFINICAO DE CORES E ESTILOS
    %% ==============================
    classDef startEnd fill:#ff6b6b,stroke:#d63031,stroke-width:3px,color:white
    classDef process fill:#74b9ff,stroke:#0984e3,stroke-width:2px,color:white
    classDef decision fill:#fdcb6e,stroke:#e17055,stroke-width:2px,color:black
    classDef database fill:#55a3ff,stroke:#2d3436,stroke-width:2px,color:white
    classDef botFlow fill:#00b894,stroke:#00a085,stroke-width:2px,color:white
    classDef humanFlow fill:#e17055,stroke:#d63031,stroke-width:2px,color:white
    classDef systemFlow fill:#a29bfe,stroke:#6c5ce7,stroke-width:2px,color:white
    classDef transferFlow fill:#fd79a8,stroke:#e84393,stroke-width:2px,color:white
    classDef sectorFlow fill:#00cec9,stroke:#00b894,stroke-width:2px,color:white
    
    %% Estilo para subgrafos da legenda (invisiveis)
    classDef legendaInvisible fill:transparent,stroke:transparent

    %% ==============================
    %% LEGENDA MELHORADA COM MAIS ESPACO
    %% ==============================
    subgraph Legenda ["ğŸ“‹ Legenda de Cores e Simbolos do Fluxo"]
        direction TB
        subgraph LegendaRow1 [" "]
            L1[ğŸš€ Inicio/Fim]:::startEnd
            L2[âš™ï¸ Processo]:::process
            L3[â“ Decisao]:::decision
        end
        subgraph LegendaRow2 [" "]
            L4[ğŸ’¾ Banco de Dados]:::database
            L5[ğŸ¤– Fluxo do Bot]:::botFlow
        end
        subgraph LegendaRow3 [" "]
            L6[ğŸ‘¤ Fluxo Humano]:::humanFlow
            L7[ğŸ”§ Sistema/Controle]:::systemFlow
        end
        subgraph LegendaRow4 [" "]
            L8[ğŸ”„ Transferencia]:::transferFlow
            L9[ğŸ¢ Setores/Especializacao]:::sectorFlow
        end
    end

    %% ==============================
    %% FLUXO PRINCIPAL SEM SUBGRAFOS
    %% ==============================
    
    %% 1. INICIO DO FLUXO
    Start[ğŸš€ 1. INICIO DO FLUXO<br/>Nova Mensagem Recebida]:::startEnd
    ReceiveMsg[ğŸ“± 1.1 webhook_whatsapp<br/>Receber Payload JSON<br/>Validar API KEY e evento<br/>Chamar nova_mensagem]:::process
    ExtractMessageData[ğŸ” 1.2 nova_mensagem<br/>Extrair nÃºmero do cliente<br/>Identificar tipo da mensagem<br/>Processar conteÃºdo por tipo<br/>Extrair metadados relevantes]:::systemFlow
    CallMessageProcessor[âš™ï¸ 1.3 processar_mensagem_whatsapp<br/>Determinar tipo de remetente<br/>Buscar/Criar atendimento<br/>Criar objeto Mensagem<br/>Atualizar timestamp cliente]:::systemFlow
    RecoverMessage[ğŸ’¾ 1.4 Recuperar Objeto Mensagem<br/>Mensagem.objects.get<br/>Obter atributos completos<br/>Acessar mensagem.atendimento]:::database
    
    %% 2. DECISAO ATENDENTE RESPONSAVEL
    CheckResponsibleAgent{ï¿½ 2.1 Atendimento tem<br/>atendente responsavel?<br/>Verificar atendimento.atendente_humano}:::decision
    DirectToResponsibleAgent[ğŸ¯ 2.2 Direcionar para Atendente Responsavel<br/>Mensagem vai diretamente<br/>para atendente definido<br/>Ignorar triagem geral]:::humanFlow
    
    %% 3. CONTROLE CENTRAL DO BOT
    BotControlLogic[ğŸ”§ 3. CONTROLE CENTRAL DO BOT<br/>Bot assume controle do atendimento<br/>Verificar condiÃ§Ãµes de resposta automÃ¡tica]:::systemFlow
    CheckBotCanRespond{â“ 3.1 _pode_bot_responder_atendimento<br/>Verificar ausÃªncia de mensagens<br/>de atendente humano<br/>Determinar se bot pode responder}:::decision
    CheckMessageNeedsProcessing{â“ 3.2 Mensagem precisa<br/>processamento especial?<br/>Verificar tipo != TEXTO}:::decision
    ProcessSpecialContent[ğŸ¤– 3.3 Processar ConteÃºdo Especial<br/>Extrair informaÃ§Ãµes contextuais<br/>Metadados especÃ­ficos por tipo<br/>Preparar para anÃ¡lise de intent]:::botFlow

    %% 4. FLUXO DE RESPOSTA DO BOT
    AnalyzeMessage[ğŸ¤– 4. FLUXO DE RESPOSTA BOT<br/>Analisar Mensagem<br/>Extrair intent e entidades<br/>Consultar base de conhecimento<br/>Processar contexto]:::botFlow
    ClassifyIntent{â“ 4.1 Classificar Intent<br/>PERGUNTA, AGRADECIMENTO<br/>SATISFACAO ou TRANSFERENCIA?}:::decision
    DetectTransferIntent[ğŸ”„ 4.1.1 Detectar Intent Transferencia<br/>Cliente solicita mudanca setor<br/>Exemplo: quero falar financeiro<br/>Identificar setor destino]:::transferFlow
    GenerateResponse[ğŸ’­ 4.2 Gerar Resposta<br/>Processar com IA<br/>Calcular confianca_resposta 0-1<br/>Preparar resposta]:::botFlow
    DetectSatisfaction[âœ… 4.3 Detectar Satisfacao<br/>Cliente demonstra satisfacao<br/>Agradecimento ou resolucao<br/>Preparar encerramento]:::botFlow
    CheckConfidence{â“ 4.4 Confianca >= 0.5?}:::decision
    TransferToHuman[ğŸ‘¤ 4.5 transferir_atendimento_automatico<br/>Baixa confianca - Transferir]:::humanFlow
    CheckHighConfidence{â“ 4.6 Confianca >= 0.8?}:::decision
    SendAutomaticResponse[ğŸ“¤ 4.7 Resposta Automatica<br/>Salvar mensagem BOT<br/>Enviar para cliente<br/>Alta confianca]:::botFlow
    RequireReview[âš ï¸ 4.8 Resposta Requer Revisao<br/>Salvar com baixa confianca<br/>Logica customizavel<br/>Confianca media]:::systemFlow
    
    %% 5. TRANSFERENCIA PARA ATENDENTE
    FindAgent[ğŸ‘¥ 5. TRANSFERENCIA PARA ATENDENTE<br/>buscar_atendente_disponivel<br/>Filtrar ativo=True, disponivel=True<br/>Verificar max_atendimentos_simultaneos<br/>Balanceamento de carga]:::humanFlow
    BuscarAtendenteDisponivel[ğŸ” 5.1 buscar_atendente_disponivel<br/>Localizacao de atendente apropriado<br/>Filtros: ativo=True, disponivel=True<br/>max_atendimentos_simultaneos<br/>Balanceamento de carga]:::systemFlow
    CheckSpecificSector{ğŸ¢ 5.1.1 Transfer solicitada<br/>para setor especifico?<br/>Verificar setor destino}:::decision
    BuscarPorSetor[ğŸ¢ 5.1.2 buscar_atendente_por_setor<br/>Filtrar por setor especifico<br/>Priorizar especialistas<br/>Verificar disponibilidade]:::sectorFlow
    AgentAvailable{â“ 5.2 Atendente Disponivel?}:::decision
    NoAgentFlow[âš ï¸ 5.3 Nenhum Atendente Disponivel<br/>Notificar administradores<br/>Aguardar intervalo<br/>Preparar nova busca]:::systemFlow
    WaitAndRetry[â³ 5.4 Aguardar e Tentar Novamente<br/>Intervalo de espera configuravel<br/>Log de tentativa<br/>Incrementar contador]:::systemFlow
    AssignAgent[ğŸ‘¤ 5.5 transferir_para_humano<br/>atendimento.atendente_humano = atendente<br/>Status: TRANSFERIDO<br/>Historico: transferencia automatica]:::humanFlow
    NotifyAgent[ğŸ“¬ 5.6 Notificar Atendente<br/>Atualizar ultima_atividade<br/>Enviar notificacao<br/>Preparar interface]:::humanFlow
    HumanTakeover[ğŸ‘¤ 5.7 Atendente Assume Controle<br/>Bot para de responder automaticamente]:::humanFlow
    
    %% 6. ATENDIMENTO HUMANO ATIVO
    WaitHumanAction[ğŸ‘¤ 6. ATENDIMENTO HUMANO ATIVO<br/>Aguardar Acao do Atendente<br/>Status: AGUARDANDO_ATENDENTE]:::humanFlow
    HumanResponse{â“ 6.1 Atendente enviou<br/>resposta?}:::decision
    WaitHumanTimeout[â° 6.1.1 Aguardar Timeout Atendente<br/>Periodo especifico configuravel<br/>Monitorar tempo limite<br/>Preparar notificacao]:::systemFlow
    NotifyAgentAgain[ğŸ“¢ 6.1.2 Notificar Atendente Novamente<br/>Alerta de timeout<br/>Lembrete de resposta pendente<br/>Incrementar contador notificacoes]:::humanFlow
    SaveHumanMessage[ğŸ’¾ 6.2 enviar_mensagem_atendente<br/>Remetente: ATENDENTE_HUMANO<br/>Atualizar ultima_atividade<br/>Metadados do atendente]:::humanFlow
    
    %% 6.5 NOVO: TRANSFERENCIA ENTRE ATENDENTES/SETORES
    CheckTransferCommand{ğŸ”„ 6.3 Atendente solicitou<br/>transferencia?<br/>Comando: /transfer}:::decision
    ProcessTransferCommand[ğŸ”„ 6.4 processar_comando_transferencia<br/>Extrair setor/atendente destino<br/>Validar permissoes<br/>Preparar historico]:::transferFlow
    SelectTransferTarget{ğŸ¯ 6.5 Tipo de Transferencia?<br/>SETOR ou ATENDENTE?}:::decision
    
    %% 6.5.1 TRANSFERENCIA POR SETOR
    TransferToSector[ğŸ¢ 6.5.1 transferir_para_setor<br/>Buscar atendentes do setor<br/>Aplicar criterios disponibilidade<br/>Balanceamento de carga setor]:::sectorFlow
    
    %% 6.5.2 TRANSFERENCIA PARA ATENDENTE ESPECIFICO
    TransferToSpecificAgent[ğŸ‘¤ 6.5.2 transferir_para_atendente_especifico<br/>Validar atendente existe<br/>Verificar disponibilidade<br/>Forcar transferencia se necessario]:::transferFlow
    
    %% 6.6 FINALIZACAO DE TRANSFERENCIA
    UpdateTransferHistory[ğŸ“ 6.6 atualizar_historico_transferencia<br/>Registrar atendente origem<br/>Registrar destino<br/>Motivo da transferencia<br/>timestamp]:::database
    NotifyNewAgent[ğŸ“¬ 6.7 notificar_novo_atendente<br/>Enviar contexto completo<br/>Historico da conversa<br/>Detalhes da transferencia]:::humanFlow
    NotifyOldAgent[ğŸ“¤ 6.8 notificar_atendente_origem<br/>Confirmar transferencia<br/>Liberar da conversa<br/>Atualizar contadores]:::humanFlow

  	%% 7. ENCERRAR ATENDIMENTO
    CloseTicketFlow[ğŸ 7. ENCERRAR ATENDIMENTO<br/>finalizar_atendimento<br/>Metodo do modelo Atendimento]:::systemFlow
    GenerateClosingMsg[ğŸ’¬ 7.1 Gerar Mensagem Final<br/>Resumo da conversa<br/>Solicitacao de avaliacao<br/>Mensagem de despedida]:::botFlow
    UpdateTicketDB[ğŸ’¾ 7.2 UPDATE Atendimento<br/>Status: RESOLVIDO<br/>data_fim = now<br/>Historico: Atendimento finalizado]:::database
    SaveClosingMsgDB[ğŸ’¾ 7.3 CREATE Mensagem<br/>Conteudo de encerramento<br/>Remetente: BOT<br/>timestamp automatico]:::database
    SendClosingMessage[ğŸ“¤ 7.4 Enviar Mensagem Final<br/>Solicitar avaliacao opcional<br/>Finalizar conversa]:::botFlow
    EndFlow[ğŸ 7.5 Fim do Fluxo<br/>Atendimento Encerrado]:::startEnd
     


    %% ==============================
    %% CONEXOES DO FLUXO PRINCIPAL
    %% ==============================
    
    %% Fluxo sequencial principal
    Start --> ReceiveMsg
    ReceiveMsg --> ExtractMessageData
    ExtractMessageData --> CallMessageProcessor
    CallMessageProcessor --> RecoverMessage
    RecoverMessage --> CheckResponsibleAgent
    
    %% Decisao atendente responsavel (JA FEITA NO PROCESSAMENTO)
    CheckResponsibleAgent -->|âœ… Sim| DirectToResponsibleAgent
    CheckResponsibleAgent -->|âŒ Nao| BotControlLogic
    
    %% Fluxo direto para atendente responsavel
    DirectToResponsibleAgent --> WaitHumanAction
    
    %% Bot assume controle (sem verificacoes redundantes)
    BotControlLogic --> CheckBotCanRespond
    
    %% VerificaÃ§Ã£o se o bot pode responder - UNICA VERIFICACAO NO FLUXO
    CheckBotCanRespond -->|âœ… Sim| CheckMessageNeedsProcessing
    CheckBotCanRespond -->|âŒ NÃ£o| WaitHumanAction
    
    %% Bifurcacao para tratamento de tipo de mensagem
    CheckMessageNeedsProcessing -->|âœ… Precisa| ProcessSpecialContent
    CheckMessageNeedsProcessing -->|âŒ NÃ£o precisa| AnalyzeMessage
    
    ProcessSpecialContent --> AnalyzeMessage
    
    AnalyzeMessage --> ClassifyIntent
    
    %% Bifurcacao por tipo de intent
    ClassifyIntent -->|â“ PERGUNTA| GenerateResponse
    ClassifyIntent -->|âœ… AGRADECIMENTO/SATISFACAO| DetectSatisfaction
    ClassifyIntent -->|ğŸ”„ TRANSFERENCIA| DetectTransferIntent
    
    %% Fluxo de transferencia por intent do cliente
    DetectTransferIntent --> FindAgent
    
    %% Fluxo de geracao de resposta para perguntas
    GenerateResponse --> CheckConfidence
    CheckConfidence -->|âŒ Nao| TransferToHuman
    CheckConfidence -->|âœ… Sim| CheckHighConfidence
    
    CheckHighConfidence -->|âœ… Sim| SendAutomaticResponse
    CheckHighConfidence -->|âŒ Nao| RequireReview
    
    %% Fluxo de satisfacao direta
    DetectSatisfaction --> CloseTicketFlow
    
    %% Fluxo especifico do BOT apos resposta
    SendAutomaticResponse --> BotWaitClientResponse
    RequireReview --> BotWaitClientResponse
    BotWaitClientResponse[â³ 4.9 Bot Aguarda Resposta Cliente<br/>Status: AGUARDANDO_CLIENTE<br/>Timeout configuravel<br/>Loop ate satisfacao ou timeout]:::botFlow
    
    %% Fluxo especifico do HUMANO apos resposta
    SaveHumanMessage --> HumanDecision
    HumanDecision{â“ 6.9 Atendente escolhe<br/>proximo passo?}:::decision
    HumanWaitClient[â³ 6.10 Humano Aguarda Cliente<br/>Status: AGUARDANDO_CLIENTE_HUMANO<br/>Sem timeout automatico<br/>Controle total do atendente]:::humanFlow
    HumanFinalizeNow[ğŸ 6.11 Atendente Finaliza Agora<br/>Decisao direta do atendente<br/>Problema resolvido<br/>Encerramento imediato]:::humanFlow
    
    %% Fluxo de Transferencia
    TransferToHuman --> FindAgent
    DetectTransferIntent --> FindAgent
    FindAgent --> BuscarAtendenteDisponivel
    BuscarAtendenteDisponivel --> CheckSpecificSector
    
    %% Bifurcacao por tipo de busca
    CheckSpecificSector -->|âœ… Sim| BuscarPorSetor
    CheckSpecificSector -->|âŒ Nao| AgentAvailable
    BuscarPorSetor --> AgentAvailable
    
    AgentAvailable -->|âœ… Sim| AssignAgent
    AgentAvailable -->|âŒ Nao| NoAgentFlow
    
    %% Loop de busca de atendente
    NoAgentFlow --> WaitAndRetry
    WaitAndRetry -.->|ğŸ”„ 5.4.1 Nova Busca Loop<br/>Tentar buscar atendente novamente<br/>Loop continuo ate encontrar| CheckSpecificSector
    
    AssignAgent --> NotifyAgent
    NotifyAgent --> HumanTakeover
    
    HumanTakeover --> WaitHumanAction
    
    %% Fluxo do Bot - Caminhos especificos
    BotWaitClientResponse -.->|ğŸ”„ 4.9.1 Nova Mensagem Cliente<br/>Retorna para inicio do fluxo<br/>Passa novamente por intent 4.1| ReceiveMsg
    BotWaitClientResponse -->|â° Timeout Cliente| CloseTicketFlow
    
    %% Fluxo Humano - Caminhos especificos  
    SaveHumanMessage --> CheckTransferCommand
    CheckTransferCommand -->|âŒ Nao| HumanDecision
    CheckTransferCommand -->|âœ… Sim| ProcessTransferCommand
    
    %% Fluxo de transferencia entre atendentes
    ProcessTransferCommand --> SelectTransferTarget
    SelectTransferTarget -->|ğŸ¢ SETOR| TransferToSector
    SelectTransferTarget -->|ğŸ‘¤ ATENDENTE| TransferToSpecificAgent
    
    %% Convergencia das transferencias
    TransferToSector --> UpdateTransferHistory
    TransferToSpecificAgent --> UpdateTransferHistory
    UpdateTransferHistory --> NotifyNewAgent
    NotifyNewAgent --> NotifyOldAgent
    NotifyOldAgent --> WaitHumanAction
    
    HumanDecision -->|ğŸ Finalizar Agora| HumanFinalizeNow
    HumanDecision -->|â³ Aguardar Cliente| HumanWaitClient
    
    HumanFinalizeNow --> CloseTicketFlow
    HumanWaitClient -.->|ğŸ”„ 6.10.1 Nova Mensagem Cliente Loop<br/>Cliente responde para atendente<br/>Reiniciar fluxo mantendo controle humano| ReceiveMsg
    
    %% Fluxo Humano antigo - ajustar para nova estrutura
    HumanFlow --> WaitHumanAction
    WaitHumanAction --> HumanResponse
    HumanResponse -->|âœ… Sim| SaveHumanMessage
    HumanResponse -->|âŒ Nao - Timeout| WaitHumanTimeout
    
    %% Loop de timeout e notificacao do atendente
    WaitHumanTimeout --> NotifyAgentAgain
    NotifyAgentAgain -.->|ğŸ”„ 6.1.3 Loop Notificacao Atendente<br/>Aguardar periodo e notificar novamente<br/>Loop continuo ate resposta ou fechamento| HumanResponse
    
    %% Fluxo de Encerramento
    CloseTicketFlow --> GenerateClosingMsg
    GenerateClosingMsg --> UpdateTicketDB
    UpdateTicketDB --> SaveClosingMsgDB
    SaveClosingMsgDB --> SendClosingMessage
    SendClosingMessage --> EndFlow
    
    %% Loops de Retorno - Estrutura hierarquica atualizada
    WaitHumanAction -.->|ğŸ”„ 6.1.4 Nova Mensagem Atendente Loop<br/>Cliente responde durante espera atendente<br/>Retornar ao inicio| ReceiveMsg
    
    %% Aplicar estilos aos subgrafos da legenda
    class LegendaRow1,LegendaRow2,LegendaRow3,LegendaRow4 legendaInvisible
    
    %% Nota: SIMPLIFICADO v5.0: Eliminadas verificaÃ§Ãµes redundantes - busca de atendimento jÃ¡ feita em 1.3
    %% Nota: CONTROLE DIRETO 2.1: VerificaÃ§Ã£o de atendente responsÃ¡vel feita logo apÃ³s recuperar mensagem
    %% Nota: BOT ASSUME CONTROLE 3.0: VerificaÃ§Ã£o bot response centralizada em um ponto Ãºnico
    %% Nota: Inclui tratamento de midia via IA 3.3 para conversao de conteudo nao-texto
    %% Nota: UNICA VERIFICACAO 3.1: "_pode_bot_responder_atendimento" realizada apenas uma vez
    %% Nota: Item 5.3-5.4-5.4.1 implementa loop continuo de busca por atendente disponivel
    %% Nota: Classificacao de Intent 4.1 determina fluxo: PERGUNTA -> resposta IA vs SATISFACAO -> encerramento vs TRANSFERENCIA
    %% Nota: Bot aguarda resposta 4.9 e retorna para inicio 4.9.1 passando novamente por classificacao intent 4.1
    %% Nota: Fluxos finais distintos - Bot 4.x simplificado vs Humano 6.x controle manual
    %% Nota: Loops hierarquicos: 4.9.1 retorno bot, 5.4.1 busca atendente, 6.1.x timeout e controle humano
    %% Nota: DIRECIONAMENTO DIRETO 2.1-2.2: Atendente responsÃ¡vel definido bypassa controle do bot
    %% Nota: NOVO 4.1.1: Intent de transferencia detectada pelo bot direciona para mudanca de setor automaticamente
    %% Nota: NOVO 5.1.1-5.1.2: Busca de atendente pode ser filtrada por setor especifico ou geral
    %% Nota: NOVO 6.3-6.8: Atendentes podem transferir entre si usando comandos, com historico completo
    %% Nota: Sistema suporta transferencia por SETOR (automatica) e por ATENDENTE ESPECIFICO (manual)
