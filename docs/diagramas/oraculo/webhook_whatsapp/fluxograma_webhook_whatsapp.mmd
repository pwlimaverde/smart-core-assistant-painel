flowchart TD

    %% ==============================
    %% DEFINICAO DE CORES E ESTILOS
    %% ==============================
    classDef startEnd fill:#ff6b6b,stroke:#d63031,stroke-width:3px,color:white
    classDef process fill:#74b9ff,stroke:#0984e3,stroke-width:2px,color:white
    classDef decision fill:#fdcb6e,stroke:#e17055,stroke-width:2px,color:black
    classDef database fill:#55a3ff,stroke:#2d3436,stroke-width:2px,color:white
    classDef botFlow fill:#00b894,stroke:#00a085,stroke-width:2px,color:white
    classDef humanFlow fill:#e17055,stroke:#d63031,stroke-width:2px,color:white
    classDef systemFlow fill:#a29bfe,stroke:#6c5ce7,stroke-width:2px,color:white
    classDef errorFlow fill:#fd79a8,stroke:#e84393,stroke-width:2px,color:white
    classDef aiFlow fill:#00cec9,stroke:#00b894,stroke-width:2px,color:white
    
    %% ==============================
    %% LEGENDA DE CORES
    %% ==============================
    subgraph Legenda ["üìã Legenda de Cores"]
        direction TB
        L1[üöÄ Inicio/Fim]:::startEnd
        L2[‚öôÔ∏è Processo]:::process
        L3[‚ùì Decisao]:::decision
        L4[üíæ Banco de Dados]:::database
        L5[ü§ñ Fluxo do Bot]:::botFlow
        L6[üë§ Fluxo Humano]:::humanFlow
        L7[üîß Sistema/Controle]:::systemFlow
        L8[üß† IA/Analise]:::aiFlow
        L9[‚ö†Ô∏è Erro/Excecao]:::errorFlow
    end

    %% ==============================
    %% 1. CAMADA DE ENTRADA
    %% ==============================
    Start[üöÄ 1. INICIO - Webhook WhatsApp]:::startEnd
    ValidateApiKey[üîß 1.1 Validar API Key]:::systemFlow
    CheckApiKeyValid{‚ùì 1.2 API Key Valida?}:::decision
    ParseJson[‚öôÔ∏è 1.3 Parse JSON Request]:::process
    CheckJsonValid{‚ùì 1.4 JSON Valido?}:::decision
    
    %% ==============================
    %% 2. CAMADA DE ORQUESTRACAO
    %% ==============================
    CallNovaMensagem[‚öôÔ∏è 2.1 Chamar nova_mensagem]:::process
    ExtractMessageData[‚öôÔ∏è 2.2 Extrair Dados da Mensagem]:::process
    DetermineMessageType{‚ùì 2.3 Tipo de Mensagem?}:::decision
    
    %% ==============================
    %% 3. CAMADA DE PROCESSAMENTO
    %% ==============================
    subgraph ProcessamentoMensagem ["üì® 3. PROCESSAMENTO DE MENSAGEM"]
        direction TB
        ProcessTextMessage[‚öôÔ∏è 3.1 Processar Texto]:::process
        ProcessMediaMessage[‚öôÔ∏è 3.2 Processar Midia]:::process
        ProcessLocationMessage[‚öôÔ∏è 3.3 Processar Localizacao]:::process
        ProcessContactMessage[‚öôÔ∏è 3.4 Processar Contato]:::process
        ProcessInteractiveMessage[‚öôÔ∏è 3.5 Processar Interativo]:::process
        ProcessReactionMessage[‚öôÔ∏è 3.6 Processar Reacao]:::process
    end
    
    CallProcessarMensagemWhatsapp[‚öôÔ∏è 3.7 Chamar processar_mensagem_whatsapp]:::process
    DetermineSenderType{‚ùì 3.8 Tipo de Remetente?}:::decision
    CreateContact[üíæ 3.9 Criar/Atualizar Contato]:::database
    CreateMessage[üíæ 3.10 Criar Mensagem]:::database
    UpdateLastInteraction[üíæ 3.11 Atualizar Ultima Interacao]:::database
    CheckFirstMessage{‚ùì 3.12 Primeira Mensagem?}:::decision
    UpdateAtendimentoStatus[üíæ 3.13 Atualizar Status Atendimento]:::database
    
    %% ==============================
    %% 4. CAMADA DE ANALISE IA
    %% ==============================
    subgraph AnaliseIA ["üß† 4. ANALISE DE IA"]
        direction TB
        CallAnalisarConteudo[üß† 4.1 Chamar _analisar_conteudo_mensagem]:::aiFlow
        LoadMessageHistory[üíæ 4.2 Carregar Historico]:::database
        CheckNonTextualContent{‚ùì 4.3 Conteudo Nao-Textual?}:::decision
        ConvertContext[üß† 4.4 Converter Contexto]:::aiFlow
        CallFeaturesCompose[üß† 4.5 Chamar FeaturesCompose]:::aiFlow
        ConfigureLlmParameters[üß† 4.6 Configurar LLM]:::aiFlow
        CallAnalisePrevia[üß† 4.7 Chamar AnalisePreviaMensagem]:::aiFlow
        FormatHistoryForLlm[üß† 4.8 Formatar Historico para LLM]:::aiFlow
        ProcessLlmResponse[üß† 4.9 Processar Resposta LLM]:::aiFlow
        ExtractIntentAndEntities[üß† 4.10 Extrair Intent e Entidades]:::aiFlow
        UpdateMessageWithAnalysis[üíæ 4.11 Atualizar Mensagem com Analise]:::database
        GetValidMetadataEntities[üíæ 4.12 Obter Entidades Validas]:::database
        ProcessContactEntities[üíæ 4.13 Processar Entidades do Contato]:::database
        UpdateContactMetadata[üíæ 4.14 Atualizar Metadados do Contato]:::database
    end
    
    %% ==============================
    %% 5. CAMADA DE DECISAO
    %% ==============================
    CheckBotCanRespond{‚ùì 5.1 Bot Pode Responder?}:::decision
    CheckHumanAgentMessages[üîß 5.2 Verificar Mensagens de Agente]:::systemFlow
    CheckAssociatedHumanAgent[üîß 5.3 Verificar Agente Associado]:::systemFlow
    
    %% ==============================
    %% 6. CAMADA DE SAIDA
    %% ==============================
    RouteToBotFlow[ü§ñ 6.1 Direcionar para Bot]:::botFlow
    RouteToHumanFlow[üë§ 6.2 Direcionar para Humano]:::humanFlow
    ReturnSuccess[üöÄ 6.3 Retornar Sucesso]:::startEnd
    
    %% ==============================
    %% TRATAMENTO DE ERROS
    %% ==============================
    ErrorApiKey[‚ö†Ô∏è E1 Erro API Key Invalida]:::errorFlow
    ErrorJsonParsing[‚ö†Ô∏è E2 Erro Parse JSON]:::errorFlow
    ErrorProcessing[‚ö†Ô∏è E3 Erro Processamento]:::errorFlow
    ErrorDatabase[‚ö†Ô∏è E4 Erro Banco de Dados]:::errorFlow
    ErrorAiAnalysis[‚ö†Ô∏è E5 Erro Analise IA]:::errorFlow
    LogError[‚öôÔ∏è E6 Log do Erro]:::process
    ReturnError[üöÄ E7 Retornar Erro]:::startEnd
    
    %% ==============================
    %% CONEXOES PRINCIPAIS
    %% ==============================
    Start --> ValidateApiKey
    ValidateApiKey --> CheckApiKeyValid
    CheckApiKeyValid -->|"‚úÖ Valida"| ParseJson
    CheckApiKeyValid -->|"‚ùå Invalida"| ErrorApiKey
    
    ParseJson --> CheckJsonValid
    CheckJsonValid -->|"‚úÖ Valido"| CallNovaMensagem
    CheckJsonValid -->|"‚ùå Invalido"| ErrorJsonParsing
    
    CallNovaMensagem --> ExtractMessageData
    ExtractMessageData --> DetermineMessageType
    
    DetermineMessageType -->|"üìù Texto"| ProcessTextMessage
    DetermineMessageType -->|"üì∑ Midia"| ProcessMediaMessage
    DetermineMessageType -->|"üìç Localizacao"| ProcessLocationMessage
    DetermineMessageType -->|"üë§ Contato"| ProcessContactMessage
    DetermineMessageType -->|"üîò Interativo"| ProcessInteractiveMessage
    DetermineMessageType -->|"üòä Reacao"| ProcessReactionMessage
    
    ProcessTextMessage --> CallProcessarMensagemWhatsapp
    ProcessMediaMessage --> CallProcessarMensagemWhatsapp
    ProcessLocationMessage --> CallProcessarMensagemWhatsapp
    ProcessContactMessage --> CallProcessarMensagemWhatsapp
    ProcessInteractiveMessage --> CallProcessarMensagemWhatsapp
    ProcessReactionMessage --> CallProcessarMensagemWhatsapp
    
    CallProcessarMensagemWhatsapp --> DetermineSenderType
    DetermineSenderType -->|"üë§ Contato"| CreateContact
    DetermineSenderType -->|"ü§ñ Bot"| CreateMessage
    DetermineSenderType -->|"üë®‚Äçüíº Agente"| CreateMessage
    
    CreateContact --> CreateMessage
    CreateMessage --> UpdateLastInteraction
    UpdateLastInteraction --> CheckFirstMessage
    CheckFirstMessage -->|"‚úÖ Primeira"| UpdateAtendimentoStatus
    CheckFirstMessage -->|"‚ùå Nao Primeira"| CallAnalisarConteudo
    UpdateAtendimentoStatus --> CallAnalisarConteudo
    
    CallAnalisarConteudo --> LoadMessageHistory
    LoadMessageHistory --> CheckNonTextualContent
    CheckNonTextualContent -->|"‚úÖ Nao-Textual"| ConvertContext
    CheckNonTextualContent -->|"‚ùå Textual"| CallFeaturesCompose
    ConvertContext --> CallFeaturesCompose
    
    CallFeaturesCompose --> ConfigureLlmParameters
    ConfigureLlmParameters --> CallAnalisePrevia
    CallAnalisePrevia --> FormatHistoryForLlm
    FormatHistoryForLlm --> ProcessLlmResponse
    ProcessLlmResponse --> ExtractIntentAndEntities
    ExtractIntentAndEntities --> UpdateMessageWithAnalysis
    UpdateMessageWithAnalysis --> GetValidMetadataEntities
    GetValidMetadataEntities --> ProcessContactEntities
    ProcessContactEntities --> UpdateContactMetadata
    
    UpdateContactMetadata --> CheckBotCanRespond
    CheckBotCanRespond --> CheckHumanAgentMessages
    CheckHumanAgentMessages --> CheckAssociatedHumanAgent
    CheckAssociatedHumanAgent -->|"ü§ñ Bot Pode"| RouteToBotFlow
    CheckAssociatedHumanAgent -->|"üë§ Humano Deve"| RouteToHumanFlow
    
    RouteToBotFlow --> ReturnSuccess
    RouteToHumanFlow --> ReturnSuccess
    
    %% ==============================
    %% CONEXOES DE ERRO
    %% ==============================
    ErrorApiKey -.-> LogError
    ErrorJsonParsing -.-> LogError
    ErrorProcessing -.-> LogError
    ErrorDatabase -.-> LogError
    ErrorAiAnalysis -.-> LogError
    LogError -.-> ReturnError
    
    %% Erros durante processamento
    CallNovaMensagem -.->|"‚ö†Ô∏è Erro"| ErrorProcessing
    CallProcessarMensagemWhatsapp -.->|"‚ö†Ô∏è Erro"| ErrorProcessing
    CreateContact -.->|"‚ö†Ô∏è Erro"| ErrorDatabase
    CreateMessage -.->|"‚ö†Ô∏è Erro"| ErrorDatabase
    UpdateLastInteraction -.->|"‚ö†Ô∏è Erro"| ErrorDatabase
    UpdateAtendimentoStatus -.->|"‚ö†Ô∏è Erro"| ErrorDatabase
    LoadMessageHistory -.->|"‚ö†Ô∏è Erro"| ErrorDatabase
    CallFeaturesCompose -.->|"‚ö†Ô∏è Erro"| ErrorAiAnalysis
    UpdateMessageWithAnalysis -.->|"‚ö†Ô∏è Erro"| ErrorDatabase
    UpdateContactMetadata -.->|"‚ö†Ô∏è Erro"| ErrorDatabase